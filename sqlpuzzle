https://www.stratascratch.com/blog/types-of-window-functions-in-sql-and-questions-asked-by-airbnb-netflix-twitter-and-uber/

Aggregation
Ranking
Ntiles
Lag/lead

1: distance_per_dollar question Uber
https://platform.stratascratch.com/coding/10302-distance-per-dollar?code_type=1
You’re given a dataset of uber rides with the traveling distance (‘distance_to_travel’) and cost (‘monetary_cost’) for each ride. First, find the difference between the distance-per-dollar for each date and the average distance-per-dollar for that year-month. Distance-per-dollar is defined as the distance traveled divided by the cost of the ride. Use the calculated difference on each date to calculate absolute average difference in distance-per-dollar metric on monthly basis (year-month).

--The output should include the year-month (YYYY-MM) and the absolute average difference in distance-per-dollar (Absolute value to be rounded to the 2nd decimal).

You should also count both success and failed request_status as the distance and cost values are populated for all ride requests. Also, assume that all dates are unique in the dataset. Order your results by earliest request date first.

The demo sample query is wrong as he only calculated the avg function on the dist_per_cost in his first x min video, but he corrected the alias and calculation in final video.

Use window function can reduce sub-query usage, but still can work this out without using window function

/* Write your SQL here. Terminate each statement with a semicolon. */

with base as
    (select request_date
    ,to_char(request_date,'YYYY-MM') as request_ym 
    ,distance_to_travel/monetary_cost as distance_per_dollar
    from uber_request_logs),
    agg as (
    select request_date
    ,distance_per_dollar
    ,avg(distance_per_dollar) over(partition by request_ym ) as avg_distance_per_dollar
    from base)
    select  request_date
    ,round(abs(distance_per_dollar-avg_distance_per_dollar)::decimal,2) as avg_diff
    from agg
    order by request_date
    ;

	 
	



